import { isFunction, isPromiseLike, utcNow } from "@nevware21/ts-utils";
import { createPromise } from "../promise/promise";
import { doAwait } from "../promise/await";
function _doneChk(isDone, state, value, thisArg) {
    let result = isDone;
    state.res = value;
    if (!result) {
        if (state.isDone && isFunction(state.isDone)) {
            return doAwait(state.isDone.call(thisArg, state), (done) => {
                state.iter++;
                return !!done;
            });
        }
        else {
            result = !!state.isDone;
        }
    }
    state.iter++;
    return result;
}
export function doWhileAsync(callbackFn, isDoneFn, thisArg) {
    let promise;
    let resolve;
    let reject = (reason) => {
        isDone = true;
        throw reason;
    };
    let isDone = false;
    let state = {
        st: utcNow(),
        iter: 0,
        isDone: isDoneFn || false
    };
    if (callbackFn) {
        const _createPromise = () => {
            return createPromise((res, rej) => {
                resolve = res;
                reject = rej;
            });
        };
        const _handleAsyncDone = (done) => {
            isDone = !!done;
            if (!isDone) {
                _processNext();
            }
            else {
                resolve(state.res);
            }
        };
        const _processNext = () => {
            while (!isDone) {
                try {
                    let cbResult = callbackFn.call(thisArg, state);
                    if (isPromiseLike(cbResult)) {
                        promise = promise || _createPromise();
                        doAwait(cbResult, (res) => {
                            try {
                                doAwait(_doneChk(isDone, state, res, thisArg), _handleAsyncDone, reject);
                            }
                            catch (e) {
                                reject(e);
                            }
                        }, reject);
                        return promise;
                    }
                    else {
                        let dnRes = _doneChk(isDone, state, cbResult, thisArg);
                        if (isPromiseLike(dnRes)) {
                            promise = promise || _createPromise();
                            doAwait(dnRes, _handleAsyncDone, reject);
                            return promise;
                        }
                        else {
                            isDone = !!dnRes;
                        }
                    }
                }
                catch (e) {
                    reject(e);
                    return promise;
                }
            }
            if (isDone && resolve) {
                resolve(state.res);
            }
            return promise || state.res;
        };
        return _processNext();
    }
}
//# sourceMappingURL=doWhileAsync.js.map